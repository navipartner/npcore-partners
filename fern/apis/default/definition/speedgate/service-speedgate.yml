# yaml-language-server: $schema=https://raw.githubusercontent.com/fern-api/fern/main/fern.schema.json

imports:
  simpleTypes: ./types-simple.yml
  compositeTypes: ./types-composite.yml
  globalApiTypes: ./../global-api-types.yml

service:
  display-name: Speedgate
  auth: true
  base-path: /speedgate

  endpoints:

    findScanners:
      docs: 
        This endpoint retrieves a list of all scanners registered within the specified company.
        <br><br><b>Scanner Id Filter</b>
        <br>The `ScannerId` parameter allows you to filter the list by scanner Id. It supports wildcards, enabling partial matches to retrieve multiple related scanners efficiently.
      path: ""
      method: GET
      request: 
        name: findScanners
        query-parameters:
          scannerId: simpleTypes.ScannerIdQueryParameter
      response:
        docs: Returns a list of scanners according t .
        type: compositeTypes.ScannerIdSetupResponseShort
      examples:
        - name: "List of scanners defined"
          docs: Example of a successful retrieval of a speedgate setup.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          query-parameters:
            scannerId: $simpleTypes.ScannerIdQueryParameter.ExampleSpeedgate
          response:
            body: $compositeTypes.ScannerIdSetupResponseShort.ExampleScannerIdSetupResponseShort

    findCategories:
      docs:
        This endpoint retrieves a list of all categories that scanners can be assigned to.
      path: /category
      method: GET
      response:
        docs: Returns a list of scanner categories.
        type: list<compositeTypes.ScannerCategory>
      examples:
        - name: "List of categories"
          docs: Example of a successful retrieval of scanner categories.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          response:
            body:
              - $compositeTypes.ScannerCategory.ExampleEntranceScanners

    getScannerSetup:
      docs: 
        This endpoint retrieves the setup details for a specific gate, such as the gate's name, location, and the admission codes it supports.  
      path: /{id}
      path-parameters:
        id: simpleTypes.ScannerSystemId
      method: GET
      request: 
        name: getSetup
      response:
        docs: Returns the setup details for the specified gate.
        type: compositeTypes.ScannerIdSetupResponse
      examples:
        - name: "Speedgate Setup"
          docs: Example of a successful retrieval of a speedgate setup.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
            id: $simpleTypes.ScannerSystemId.ExampleScannerSystemId
          response:
            body: $compositeTypes.ScannerIdSetupResponse.ExampleScannerIdSetupResponse


    tryAdmit:
      docs: 
        This endpoint attempts to validate a customer's reference number and identifies it as either a ticket, member card, or wallet. Each type provides different responses.
        <br><br><b>Ticket Reference</b> Returns a single token that you can use with the admitToken endpoint.
        <br><br><b>Member Card</b> Reference Returns a primary token for the member and additional tokens for any guests, with details such as guest type and max number of guests.
        <br><br><b>Wallet Reference</b> Returns a list of tickets, each with relevant admission details, which can be individually used in subsequent calls to tryAdmit.
        <br><br><b>City Card Reference</b> Returns a token for the city card, which can be used with the admit endpoint.
        <br><br><b>Ticket Token Reference</b> Returns an admit token and a list of tickets that will be admitted when the admit token is used.
      path: /try
      method: POST
      request: 
        name: tryAdmit
        body: compositeTypes.TryAdmitRequest
      response:
        docs: Returns the result of the try to admit a customer.
        type: compositeTypes.TryAdmitResponse

      examples:
        - name: "Ticket Reference"
          docs: Example of a successful identification of a ticket.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleTicketNumber
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: ticket
              ticket: $compositeTypes.TicketDetail.ExampleTicketDetail

        - name: "Member Card Reference"
          docs: Example of a successful identification of a member card with guests.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleMemberCard
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: memberCard
              memberCard: $compositeTypes.MemberCardDetails.ExampleMemberCardDetails

        - name: "Wallet Reference"
          docs: Example of a successful identification of a wallet reference.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: wallet
              wallet: 
                walletId: $simpleTypes.WalletId.ExampleWalletId
                referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
                originatesFromItemNo: $simpleTypes.OriginatesFromItemNo.ExampleWalletNo
                printedAt: $simpleTypes.PrintedAt.ExamplePrintedAt
                printCount: $simpleTypes.PrintCount.ExamplePrintCount
                validToAdmit: true
                tickets:
                  - $compositeTypes.TicketDetail.ExampleTicketDetail

        - name: "CityCard Reference"
          docs: Example of a successful identification of a city card from DocLX.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleCityCard
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: docLxCityCard
              docLxCityCard: $compositeTypes.DocLxCityCardDetails.ExampleSuccess

        - name: "Ticket Token Reference"
          docs: Example of a successful identification of a ticket token as seen from the ticket reservation request.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleTicketToken
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: ticketRequest
              ticketRequest: $compositeTypes.TicketRequestDetails.ExampleTicketRequestDetails

    tryAndAttemptAdmit:
      docs: |
        This endpoint combines the [tryAdmit](try-admit) and [admitToken](admit-token) steps into a single call, eliminating a network
        round-trip for straightforward admissions. The server first resolves the reference number, then immediately attempts to admit the
        resolved token if admission can be determined without operator input.

        <b>⚠ HTTP 200 does NOT mean admission was completed — always inspect `admittedTokens`</b>
        <br>A successful HTTP 200 response only confirms that the reference number was recognized. Whether admission was actually carried
        out must be determined by examining the `admittedTokens` array in the response.

        <b>`admittedTokens` is non-empty</b> — Admission was completed automatically. The gate should open.

        <b>`admittedTokens` is empty</b> — The reference number was recognized and one or more follow-up reference numbers may have been
        issued, but admission could not be completed without additional operator input. The caller MUST follow up with a call to either
        [`/admit`](admit-token) or [`/tryAndAttemptAdmit`](try-and-attempt-admit), using either the issued token (if available) or a
        reference number from this response, together with any additional information the UI has gathered from the operator (e.g., which
        ticket to use or how many attendees to admit).

        <b>When will `admittedTokens` be empty?</b>
        <br>Automatic admission is skipped whenever the server cannot unambiguously resolve the admission intent. Common scenarios include:

        - <b>Wallet containing multiple valid assets</b> — The wallet holds more than one asset that is eligible for admission at this gate
          and the system cannot choose one on behalf of the operator. `wallet.validToAdmit` will be false. Present the wallet’s assets to
          the operator, let them select the correct asset, then call this endpoint again with the selected asset’s reference number from
          the operator response.

        - <b>Group ticket with unconfirmed attendee count</b> — A group ticket requires the operator to confirm the actual number of
          attendees before admission can proceed. Call [`/admit`](admit-token) with the token and the confirmed quantity.

        <b>Membership allowing guests</b>
        <br>If the reference number corresponds to a membership, the member card itself may be admitted automatically (so `admittedTokens`
        is non-empty). In that case, check the `guests` array for potential complimentary guests. Guests are not admitted automatically
        because the system needs the operator to confirm which guests to admit. Call [`/admit`](admit-token) with the corresponding admit
        token and the quantity of guests to admit for the selected category.

      path: /tryAndAttemptAdmit
      method: POST
      request:
        name: tryAndAttemptAdmit
        body: compositeTypes.TryAdmitRequest
      response:
        docs: Returns the try result including type-specific details and any tokens that were automatically admitted.
        type: compositeTypes.TryAndAttemptAdmitResponse

      examples:
        - name: "Ticket - Automatically Admitted"
          docs:
            The happy path for a simple ticket scan. The ticket was identified and admitted within
            a single call. admittedTokens contains one entry — the gate should open immediately.
            No follow-up call to /admit is needed.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleTicketNumber
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: ticket
              ticket: $compositeTypes.TicketDetail.ExampleTicketDetail
              admittedTokens:
                - $compositeTypes.AdmitResponse.ExampleAdmitTicketResponse

        - name: "Wallet - Single Valid Ticket, Automatically Admitted"
          docs:
            The wallet contains exactly one ticket eligible for admission at this gate.
            wallet.validToAdmit is true, so the server admitted it automatically.
            admittedTokens contains one entry — the gate should open. No follow-up call to /admit is needed.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: wallet
              wallet:
                walletId: $simpleTypes.WalletId.ExampleWalletId
                referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
                originatesFromItemNo: $simpleTypes.OriginatesFromItemNo.ExampleWalletNo
                printedAt: null
                printCount: 0
                validToAdmit: true
                tickets:
                  - $compositeTypes.TicketDetail.ExampleTicketDetail
              admittedTokens:
                - $compositeTypes.AdmitResponse.ExampleAdmitWalletResponse

        - name: "Wallet - Multiple Valid Tickets, Operator Selection Required"
          docs:
            The wallet contains more than one ticket eligible for admission. The server cannot determine
            which ticket to use without operator input, so admittedTokens is empty.
            The gate must NOT open. wallet.validToAdmit is false.
            Present wallet.tickets to the operator, let them select a ticket, then call this endpoint again with
            the selected ticket from this response to complete the admission.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
            scannerId: $simpleTypes.ScannerId.ExampleSpeedgate
            admissionCode: $simpleTypes.AdmissionCode.ExampleAdmissionCastle
          response:
            body:
              token: $simpleTypes.Token.ExampleAdmitToken
              referenceNumberType: wallet
              wallet:
                walletId: $simpleTypes.WalletId.ExampleWalletId
                referenceNumber: $simpleTypes.ReferenceNumber.ExampleWalletId
                originatesFromItemNo: $simpleTypes.OriginatesFromItemNo.ExampleWalletNo
                printedAt: null
                printCount: 0
                validToAdmit: false
                tickets:
                  - $compositeTypes.TicketDetail.ExampleTicketDetail
                  - $compositeTypes.TicketDetail.ExampleTicketDetail2
              admittedTokens: []

    admitToken:
      docs:
        This endpoint processes tokens received from tryAdmit to grant admission. Each token in the request specifies a quantity for admission (useful for guests).
        <br><br><b>Single Token Admission</b> Admit a single ticket by providing its token.
        <br><b>Multiple Token Admission</b> Use multiple tokens to admit a member and their guests, specifying quantities for each guest token (default is 1).
        <br><br>The request payload must include tokens and relevant quantity to admit (default is 1). If admission fails, an error message is returned.
      path: /admit
      method: POST
      request: 
        name: admitToken
        body: compositeTypes.AdmitRequest
      response:
        docs: Returns the result of the admit of a customer.
        type: AdmittedTokensResponse
      examples:
        - name: Admit Ticket
          docs: Example of a successful admission of a ticket.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            tokens:
               - token: $simpleTypes.Token.ExampleAdmitToken
          response:
            body:
              admittedTokens:
                - $compositeTypes.AdmitResponse.ExampleAdmitTicketResponse
        - name: Admit MemberCard
          docs: Example of a successful admission of a Member Card.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            tokens:
              - token: $simpleTypes.Token.ExampleAdmitToken
          response:
            body:
              admittedTokens:
                - $compositeTypes.AdmitResponse.ExampleAdmitMemberCardResponse
  
    failAdmitToken:
      docs: 
        This endpoint marks a token as invalid, preventing its future use for admission. 
        It can also fail an already admitted token, effectively revoking the speedgate admission. 
        Note, however, that the actual admission cannot be undone in the system; only the speedgate token can be marked as failed.
        This is useful for handling situations where scanner personnel override the business rules of an admission attempt.
      path: /failAdmitToken
      method: PUT
      request: 
        name: failAdmitToken
        body: compositeTypes.FailAdmitTokenRequest
      response:
        type: FailAdmitTokenResponse
      examples: 
        - name: "Fail Admit Token"
          docs: Example of a successful failure of an admit token.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          request:
            token: $simpleTypes.Token.ExampleAdmitToken
            reason: $simpleTypes.FailAdmitReason.Reason_1
          response:
            body: {}


    referenceNumberLookup:
      docs: 
        This endpoint retrieves the details of a reference number, including its type and status. 
        It can be used to check the history of a reference number.
      path: "/lookup"
      method: GET
      request: 
        name: referenceNumberLookup
        query-parameters:
          referenceNumber: simpleTypes.ReferenceNumber
          fromDate: optional<FromAdmittedAt>
      response:
        docs: Returns a list all usages of the reference number in the speedgate.
        type: list<compositeTypes.ReferenceNumberLookupResponse>
      examples:
        - name: "Usage log for reference number"
          docs: Example of a successful retrieval of log for a reference number.
          path-parameters:
            tenant: $globalApiTypes.tenant.Exampletenant
            environment: $globalApiTypes.environment.ExampleenvironmentProduction
            company: $globalApiTypes.Company.ExampleCompanyCronus
          query-parameters:
            referenceNumber: $simpleTypes.ReferenceNumber.ExampleTicketNumber
          response:
            body: 
              - $compositeTypes.ReferenceNumberLookupResponse.Example1


types:
  AdmittedTokensResponse:
    properties:
      admittedTokens: list<compositeTypes.AdmitResponse>

  FailAdmitTokenResponse:
    properties: {}

  FromAdmittedAt:
    type: date 
    docs: The date from which to start looking for reference number usages. Default is today. Date only, time is assumed to be 00:00:00 format ISO 8601 (YYYY-MM-DD).
