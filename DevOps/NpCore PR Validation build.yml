trigger: none

resources:
  repositories:
  - repository: scriptsRepo
    type: git
    name: 'NpCore/NpDevOps'

pool:
  name: NP Core Pull Request Pipelines
  demands: 
  - docker
  # Now only 2019 is available but in the future it will be every newer version.
  # Then we will probably remove this requirement as it will alwyas TRUE.
  - Agent.OS -equals Windows_NT
  - Agent.OSVersion -equals 10.0.17763

variables:
  containerName: Build-$(Build.BuildId)
  serverInstanceName: BC
  containerAdminUsername: admin
  containerAdminPassword: P@ssword1

jobs:
- template: YAML/Templates/Job/CreateBCContainer.yml@scriptsRepo
  parameters:
    timeoutInMinutes: 180
    containerImageName: mcr.microsoft.com/dynamicsnav:10.0.17763.1397-generic
    pipelineConfig: '$(Build.SourcesDirectory)/$(Build.Repository.Name)/DevOps/PipelineConfig.json' #-Insider.json'
    containerName: $(containerName)
    serverInstanceName: $(serverInstanceName)
    containerAdminUsername: $(containerAdminUsername) 
    containerAdminPassword: $(containerAdminPassword)
    licenseSecureFileName: 'DEV_BC OP 17.flf'
    scriptsRepo: ScriptsRepo
    stepList:
    - template: YAML/Templates/Step/BuildALApp.yml@scriptsRepo
      parameters:
        containerName: $(containerName)
        containerAdminUsername: $(containerAdminUsername)
        containerAdminPassword: $(containerAdminPassword)
        serverInstanceName: $(serverInstanceName)
        alProjectRoot: $(Build.SourcesDirectory)/$(Build.Repository.Name)/Application
        analyzers: 'AppSourceCop,UICop'
        dependancies:
        - package:
            source: 'https://api.nuget.org/v3/index.json;https://pkgs.dev.azure.com/navipartner/_packaging/NprAddIns/nuget/v3/index.json'
            id: NaviPartner.NPRetail.AddIns.BC #CASE SENSITIVE!
            destinationPath: '$(ServiceTierFolder)/Add-Ins'
        latestPrereleaseAppNuGetSource: 
          source: 'https://pkgs.dev.azure.com/navipartner/_packaging/NpCore/nuget/v3/index.json'
          id: NaviPartner.NPCore.BC170

    - template: YAML/Templates/Step/BuildALApp.yml@scriptsRepo
      parameters:
        containerName: $(containerName)
        containerAdminUsername: $(containerAdminUsername)
        containerAdminPassword: $(containerAdminPassword)
        serverInstanceName: $(serverInstanceName)
        alProjectRoot: $(Build.SourcesDirectory)/$(Build.Repository.Name)/Test

    - template: YAML/Templates/Step/HandleDependancies.yml@scriptsRepo 
      parameters:
        dependancies:
        - appsToDeploy:
          - path: 'C:\Applications\TestFramework\TestRunner\Microsoft_Test Runner.app'
          - path: 'C:\Applications\TestFramework\TestLibraries\Assert\Microsoft_Library Assert.app'
          - path: 'C:\Applications\TestFramework\TestLibraries\Any\Microsoft_Any.app'
          - path: 'C:\Applications\TestFramework\TestLibraries\Variable Storage\Microsoft_Library Variable Storage.app'
          - path: 'C:\Applications\system application\test\Microsoft_System Application Test Library.app'
          - path: 'C:\Applications\baseapp\test\Microsoft_Tests-TestLibraries.app'
        serverInstanceName: $(serverInstanceName)

    - template: YAML/Templates/Step/SetupAndRunTests.yml@scriptsRepo
      parameters:
        serverInstanceName: $(serverInstanceName)
        username: $(containerAdminUsername)
        password: $(containerAdminPassword)
        testRunName: 'NPCore Tests'
        testApps:
          - appPath: $(Build.SourcesDirectory)/$(Build.Repository.Name)/Test/Output/Test.app