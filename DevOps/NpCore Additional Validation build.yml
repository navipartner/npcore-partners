trigger: none

schedules:
  - cron: "0 22 * * *" #UTC TIME! mm HH DD MM DW
    displayName: Daily after-midnight test runner build
    branches:
      include:
      - masters/NPR_BC17_W1

resources:
  repositories:
  - repository: scriptsRepo
    type: git
    name: 'NpCore/NpDevOps'
    ref: 'refs/heads/releases/1.0'

pool:
  name: NP Core Pipelines
  demands: 
  - docker
  # Now only 2019 is available but in the future it will be every newer version.
  # Then we will probably remove this requirement as it will alwyas TRUE.
  - Agent.OS -equals Windows_NT
  - Agent.OSVersion -equals 10.0.17763

variables:
  containerName: Build-$(Build.BuildId)
  serverInstanceName: BC
  containerAdminUsername: admin
  containerAdminPassword: P@ssword1

jobs:
- template: YAML/Templates/Build/MainBuild.yml@scriptsRepo
  parameters:
    scriptsRepo: scriptsRepo
    stepList:
    - checkout: self

    - task: PowerShell@2
      inputs:
        filePath: $(psScriptsFolder)/BuildDeploy/CalculateNewVersion.ps1
        arguments: >
          -MajorVersion $(majorVersion)
          -Prerelease
      env:
        SYSTEM_ACCESSTOKEN: $(System.AccessToken)
      displayName: 'Calculate new version'

    - template: YAML/Templates/Step/BuildALApp.yml@scriptsRepo
      parameters:
        containerName: $(containerName)
        containerAdminUsername: $(containerAdminUsername)
        containerAdminPassword: $(containerAdminPassword)
        serverInstanceName: $(serverInstanceName)
        alProjectRoot: $(Build.SourcesDirectory)/$(Build.Repository.Name)/Application
        appVersion: $(NewAppVersion)
        dependancies:
        - package:
            source: 'https://api.nuget.org/v3/index.json;https://pkgs.dev.azure.com/navipartner/_packaging/NprAddIns/nuget/v3/index.json'
            id: NaviPartner.NPRetail.AddIns.BC #CASE SENSITIVE!
            destinationPath: '$(ServiceTierFolder)/Add-Ins'
        alternativeSystemALPackages:
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.at
          ISOcountryCode: AT
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.au
          ISOcountryCode: AU
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.be
          ISOcountryCode: BE
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.ca
          ISOcountryCode: CA
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.ch
          ISOcountryCode: CH
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.cz
          ISOcountryCode: CZ
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.de
          ISOcountryCode: DE
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.dk
          ISOcountryCode: DK
        # - packages:
        #   - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
        #     id: Microsoft.BC.170.Base_Application.es
        #   ISOcountryCode: ES
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.fi
          ISOcountryCode: FI          
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.fr
          ISOcountryCode: FR
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.gb
          ISOcountryCode: GB
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.is
          ISOcountryCode: IS
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.it
          ISOcountryCode: IT
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.mx
          ISOcountryCode: MX
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.nl
          ISOcountryCode: NL
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.no
          ISOcountryCode: NO
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.nz
          ISOcountryCode: NZ        
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.se
          ISOcountryCode: SE
        - packages:
          - source: 'https://pkgs.dev.azure.com/navipartner/_packaging/BCSymbols/nuget/v3/index.json'
            id: Microsoft.BC.170.Base_Application.us
          ISOcountryCode: US